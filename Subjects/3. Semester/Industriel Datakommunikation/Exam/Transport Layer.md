# Relevant Lectures
- [[L3 - The Application layer 1]] more specifically [[TheApplicationLayer_I.pdf#page=24|page 24]] to [[TheApplicationLayer_I.pdf#page=28|page 28]]
- [[L5 - The Transport layer 1]]
- [[L6 - The Transport layer 2]]
- [[L12 - Security]]

# Relevant Materials
- L5: p. 215 - 289
- L6: p. 286 - 314

# Relevant Themes
- Surrounding layers [[TransportLayer 1.pdf#page=7|L5 page 7]]
	- Upper: _Socket_ to Application Layer. Sends and delivers messages through socket
	- Lower: Sends and receives segments to and from remote host
- Packets at this level is called **Segments** [[TransportLayer 1.pdf#page=7|L5 page 7]]
- What transport service does an app need? [[TransportLayer 1.pdf#page=10|L5 page 10]]
	- Reliable data transfer
	- Timing
	- Throughput
	- Security
- What can be expected of Transport Layer? [[TransportLayer 1.pdf#page=11|L5 page 11]]
	- Must haves:
		- Breaking messages into _segments_.
		- Multiplexing/demultiplexing
	- Connection management
	- Reliable data transfer
		- Error detection and recovery
		- In order delivery (packet1, packet2, ... )
	- Timing
	- Throughput
		- Flow control
		- Congestion control
	- Security
- In contrast to Network Layer (that focuses on communication between hosts), Transport Layer focuses on communication between _processes_ [[TransportLayer 1.pdf#page=12|L5 page 12]]
	- Uses IP and Port numbers
- **Sender side:** Receives message from App layer → Breaks message into segments → Passes to Network layer [[TransportLayer 1.pdf#page=14|L5 page 14]]
- **Receiver side:** Receives segments from Network layer → Reassembles segments to message → passes to App layer [[TransportLayer 1.pdf#page=14|L5 page 14]]
- Most common protocols on internet: TCP and UDP [[TransportLayer 1.pdf#page=14|L5 page 14]]

## UDP
- Must have:
	- Breaking messages into segments: **Yes**
	- Multiplexing/demultiplexing: **Yes**
- Connection management: Connectionless communication (doesn't establish channel before sending segments)
- Reliable data transfer: **No ("best effort")**
	- Error Detection: Checksum
	- Error recovery: No
	- In order delivery No
- Timing: None
- Throughput: No
	- Flow control: None
	- Congestion Control: None
- Security: None
- UDP Header [[TransportLayer 1.pdf#page=19|L5 page 19]]
	- Source port: Socket of sender (16 bits)
	- Destination Port: Socket of receiver (16 bits)
	- Length: Length, in bytes, of UDP segment, including header (16 bits)
	- Checksum (16 bits)
- Connectionless demultiplexing: Different communication partners will all direct communication to _same_ socket on receiver [[TransportLayer 1.pdf#page=18|L5 page 18]]

## TCP
- Must have:
	- Breaking messages into segments: **Yes**
	- Multi-/demultiplexing: **Yes**
- Connection management: Connection-oriented communication (establishes connection bfore sending segments)
- Reliable data transfer: **Yes**
	- Error detection: Checksum
	- Error recovery: Yes
	- In order deliver: Yes
- Timing: None
- Throughput: No
	- Flow control: Yes
	- Congestion control: Yes
- Security: None
- Point-to-point (one sender, one receiver) [[TransportLayer 1.pdf#page=24|L5 page 24]]
- Reliable, in-order _byte steam_ (No message boundaries) [[TransportLayer 1.pdf#page=24|L5 page 24]]
- Pipelined (Does not have to wait to send next packet) [[TransportLayer 1.pdf#page=24|L5 page 24]]
- Full duplex data: (Bi-directional data flow in same connection) [[TransportLayer 1.pdf#page=24|L5 page 24]]
	- MSS: Maximum segment size
- Connection-oriented (Handshake initializes sender-receiver state before data exchange) [[TransportLayer 1.pdf#page=24|L5 page 24]]
- Flow controlled (Sender will not overwhelm receiver) [[TransportLayer 1.pdf#page=24|L5 page 24]]
- TCP Header [[TransportLayer 1.pdf#page=25|L5 page 25]]
	- Source port: Socket of sender (16 bits)
	- Destination port: Socket of receiver (16 bits)
	- Sequence number:  Segment sequence (32 bits)
	- Acknowledgment number: Ack sequence number (32 bits)
	- Header length (5 bits (I think))
	- URG: Urgent data (generally not used) (1 bit)
	- ACK number valid (1 bit)
	- PSH push data now (generally not used) (1 bit)
	- RST, SYN, FIN: connection establishment (setup, teardown commands) (1 bit each)
	- Receive window: Number of bytes receiver is willing to accept (for flow control) (16 bits)
	- Checksum (16 bits)
	- URG data pointer (16 bits)
	- Options (variable length, but each "block" is 32 bits)
- Sequence number: Byte stream number of first byte in segment's data [[TransportLayer 1.pdf#page=16|L5 page 26]]
- Acknowledgments: Seq number of next byte expected from other side [[TransportLayer 1.pdf#page=16|L5 page 26]]
	- Cumulative ACK
	- Example: Sender (Seq=42, ACK=79) → Receiver (Seq=79, ACK=43) → Sender (Seq=43, ACK=80) [[TransportLayer 1.pdf#page=27|L5 page 27]]
- Connection-oriented demux: Different communcation partners will all direct messages to same _port_ (eg. port 80) but for different communications, the port is split into different _sockets_. [[TransportLayer 1.pdf#page=29|L5 page 29]]
	- Can also be a threaded server ?? see [[TransportLayer 1.pdf#page=30|L5 page 30]]
- TCP ensures reliable data transfer on top of IP's unreliable service [[TransportLayer 1.pdf#page=31|L5 page 31]]
	- Pipelined segments
	- Cumulative ACKs
	- Single retransmission timer
	- Retransmissions triggered by:
		- Timeout events
		- Duplicate Acks
- If Sender sends (Seq=92, Seq=100, Seq=..., Seq=..., Seq=...) and receives ACK=100, ACK=100, ACK=100, ACK=100, It is likely that Seq=100 got lost, so retransmit. [[TransportLayer 1.pdf#page=page=34|L5 page 34]]
- Handshake before transmission of data [[TransportLayer 1.pdf#page=35|L5 page 35]]
- Closing TCP connection [[TransportLayer 1.pdf#page=38|L5 page 38]]
	- Client and Server each close their side of connection (send TCP segment with FIN bit =1)
	- Respond to received FIN with ACK
		- Can be combined with own FIN when receving FIN. Thus sending FIN and ACK
	- Simultaneous FIN exchange can be handled

### TCP Timeout
- Should be longer than RTT (Round Trip Time) [[TCP_continued.pdf#page=9|L6 page 9]]
	- But RTT varies
	- _Too short:_ premature timeout. Unnecessary retransmissions
	- _To long:_ Slow reaction to segment loss
- Take **SampleRTT** which is measured time from segment transmission to ACK receipt
	- Ignore retransmissions
	- Will still vary, so want smoother estimate
		- Average _several_ **recent** measurements, not just current
- $\text{EstimatedRTT}=(1-\alpha)*\text{EstimatedRTT}+\alpha*\text{SampleRTT}$ [[TCP_continued.pdf#page=10|L6 page 10]]
	- **EWMA** *E*xponential *W*eighted *M*oving *A*verage
	- Influence of past samles decreases exponentially fast
	- Typical value: $\alpha=0.125$
- Timeout interval is then EstimatedRTT plus safety margin [[TCP_continued.pdf#page=11|L6 page 11]]
	- $\text{TimeoutInterval}=\text{EstimatedRTT}+4*\text{DevRTT}$
	- $\text{DevRTT}=(1-\beta)*\text{DevRTT}+\beta*|\text{SampleRTT}-\text{EstimatedRTT}|$
		- EWMA of SampleRTT deviation from EstimatedRTT
- 